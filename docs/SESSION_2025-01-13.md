# SesiÃ³n de Trabajo - 13 de Enero 2025

## Resumen de la SesiÃ³n

Esta sesiÃ³n se enfocÃ³ en dos problemas crÃ­ticos identificados por el usuario:
1. Falta de filtrado por instituciÃ³n en pÃ¡ginas de consultorios y servicios
2. Falta de control de acceso basado en roles (usuarios veÃ­an opciones que no podÃ­an usar)

---

## Problema 1: Filtrado por InstituciÃ³n

### ğŸ”´ Problema Reportado
- Usuario logueado veÃ­a **todos** los consultorios y servicios de **todas** las instituciones
- DebÃ­a ver solo los de su instituciÃ³n actual

### âœ… SoluciÃ³n Implementada

#### Archivos Modificados:

**1. `app/(dashboard)/consultorios/page.tsx`**
- **LÃ­nea 80**: Agregado filtro `.eq('institution_id', context.institution_id)` en `fetchRooms()`
- **LÃ­nea 119**: Modificado `fetchInstitutions()` para cargar solo la instituciÃ³n actual con `.single()`
- **LÃ­neas 55-62**: Agregado `useEffect` para inicializar `currentInstitutionId` y `formData.institution_id`
- **LÃ­neas 150-154**: Agregada validaciÃ³n de `institution_id` en `handleSubmit()`
- **LÃ­neas 265-267**: Modificado `resetForm()` para mantener el `institution_id`
- **LÃ­neas 345-351**: Cambiado formulario de `Select` a `Input` deshabilitado mostrando instituciÃ³n actual

**2. `app/(dashboard)/servicios/page.tsx`**
- **YA ESTABA CORRECTO** âœ…
- LÃ­nea 91: Ya tenÃ­a `.eq('institution_id', context.institution_id)`
- Se usÃ³ como referencia para los cambios en consultorios

### ğŸ“ PatrÃ³n Implementado

```typescript
// 1. En useEffect inicial
const contextData = localStorage.getItem('institution_context')
const context = JSON.parse(contextData)
setCurrentInstitutionId(context.institution_id)
setFormData(prev => ({ ...prev, institution_id: context.institution_id }))

// 2. En fetch de datos
const { data, error } = await supabase
  .from('tabla')
  .select('...')
  .eq('institution_id', context.institution_id) // â† FILTRO CLAVE
  .order('name', { ascending: true })

// 3. En formulario
<Input
  value={institutions[0]?.name ? `${institutions[0].name} - ${institutions[0].zone_name}` : 'Cargando...'}
  disabled
  className="bg-gray-100"
/>

// 4. En validaciÃ³n
if (!formData.institution_id) {
  setError('No se ha establecido la instituciÃ³n')
  return
}
```

### ğŸ¯ Resultado
- Usuarios solo ven datos de su instituciÃ³n
- Imposible crear/editar recursos para otras instituciones
- Formularios muestran instituciÃ³n actual como campo deshabilitado

---

## Problema 2: Control de Acceso Basado en Roles (RBAC)

### ğŸ”´ Problema Reportado
- Usuario logueado como "EnfermerÃ­a" veÃ­a **todas las opciones del dashboard**
- PodÃ­a intentar acceder a pÃ¡ginas administrativas (profesionales, servicios, consultorios, configuraciÃ³n)
- No habÃ­a control de acceso basado en roles

### âœ… SoluciÃ³n Implementada

#### Archivos Creados:

**1. `lib/permissions.ts`** - Sistema central de permisos
```typescript
export type UserRole = 'admin' | 'administrativo' | 'medico' | 'enfermeria' | 'pantalla'

export const routePermissions: Record<string, UserRole[]> = {
  '/dashboard': ['admin', 'administrativo', 'medico', 'enfermeria'],
  '/turnos': ['admin', 'administrativo'],
  '/agenda': ['admin', 'administrativo', 'medico'],
  '/profesionales': ['admin'],
  '/servicios': ['admin'],
  '/consultorios': ['admin'],
  '/reportes': ['admin', 'administrativo'],
  '/configuracion': ['admin'],
}

export function hasPermission(userRole: UserRole, route: string): boolean {
  const allowedRoles = routePermissions[route]
  if (!allowedRoles) return false // Denegar por defecto
  return allowedRoles.includes(userRole)
}
```

**2. `hooks/use-permissions.ts`** - Hook personalizado React
```typescript
export function useRequirePermission(route: string) {
  const router = useRouter()
  const [hasAccess, setHasAccess] = useState(false)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const contextData = localStorage.getItem('institution_context')
    const context = JSON.parse(contextData)
    const userRole = context.user_role as UserRole

    const permitted = hasPermission(userRole, route)

    if (!permitted) {
      console.warn(`Usuario con rol ${userRole} intentÃ³ acceder a ${route} sin permiso`)
      router.push('/dashboard')
      return
    }

    setHasAccess(true)
    setLoading(false)
  }, [route, router])

  return { hasAccess, loading }
}
```

**3. `docs/PERMISSIONS.md`** - DocumentaciÃ³n completa del sistema

#### Archivos Modificados:

**1. `app/(dashboard)/layout.tsx`**

**LÃ­neas 24-74**: DefiniciÃ³n de navegaciÃ³n con roles
```typescript
const navigation = [
  {
    name: 'Dashboard',
    href: '/dashboard',
    icon: HomeIcon,
    roles: ['admin', 'administrativo', 'medico', 'enfermeria']
  },
  {
    name: 'Turnos',
    href: '/turnos',
    icon: ClockIcon,
    roles: ['admin', 'administrativo'] // Solo admin y administrativo
  },
  {
    name: 'Agenda',
    href: '/agenda',
    icon: CalendarIcon,
    roles: ['admin', 'administrativo', 'medico']
  },
  {
    name: 'Profesionales',
    href: '/profesionales',
    icon: UsersIcon,
    roles: ['admin'] // Solo admin
  },
  // ... etc
]
```

**LÃ­neas 194-197**: Filtrado automÃ¡tico de navegaciÃ³n
```typescript
// Filtrar navegaciÃ³n segÃºn el rol del usuario
const allowedNavigation = navigation.filter(item =>
  item.roles.includes(institutionContext.user_role)
)
```

**LÃ­nea 215**: Uso de navegaciÃ³n filtrada
```typescript
{allowedNavigation.map((item) => { /* ... */ })}
```

**2. `app/(dashboard)/configuracion/page.tsx`** - Ejemplo de protecciÃ³n

**LÃ­nea 13**: Import del hook
```typescript
import { useRequirePermission } from '@/hooks/use-permissions'
```

**LÃ­nea 23**: VerificaciÃ³n de permisos
```typescript
const { hasAccess, loading: permissionLoading } = useRequirePermission('/configuracion')
```

**LÃ­neas 116-130**: Manejo de loading y acceso
```typescript
if (permissionLoading || loading) {
  return <LoadingSpinner />
}

if (!hasAccess) {
  return null // El hook ya redirigiÃ³
}
```

### ğŸ“Š Matriz de Permisos Implementada

| Rol | Dashboard | Turnos | Agenda | Profesionales | Servicios | Consultorios | Reportes | Config |
|-----|-----------|--------|--------|---------------|-----------|--------------|----------|--------|
| **admin** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **administrativo** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ | âœ… | âŒ |
| **medico** | âœ… | âŒ | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| **enfermeria** | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| **pantalla** | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |

### ğŸ”’ Capas de Seguridad

1. **Capa 1 - UI**: Filtrado del menÃº (usuarios no ven opciones prohibidas)
2. **Capa 2 - Routing**: Hook `useRequirePermission` redirige si acceden por URL directa
3. **Capa 3 - Backend**: RLS de Supabase (ya existente)

### ğŸ¯ Resultado
- MenÃº dinÃ¡mico segÃºn rol del usuario
- ProtecciÃ³n contra acceso directo por URL
- Logs de intentos no autorizados
- Sistema extensible y documentado

---

## ğŸ“‹ Estado Actual del Sistema

### âœ… Completado
- [x] Filtrado por instituciÃ³n en `/consultorios`
- [x] Filtrado por instituciÃ³n en `/servicios` (ya existÃ­a)
- [x] Sistema de permisos RBAC completo
- [x] Filtrado dinÃ¡mico del menÃº de navegaciÃ³n
- [x] Hook `useRequirePermission` para proteger rutas
- [x] ProtecciÃ³n implementada en `/configuracion`
- [x] DocumentaciÃ³n completa en `docs/PERMISSIONS.md`

### â³ Pendiente

#### Proteger PÃ¡ginas Restantes
Las siguientes pÃ¡ginas necesitan agregar protecciÃ³n con `useRequirePermission`:

1. **`app/(dashboard)/profesionales/page.tsx`**
   - Solo admin debe acceder
   - Agregar: `const { hasAccess, loading } = useRequirePermission('/profesionales')`

2. **`app/(dashboard)/turnos/page.tsx`**
   - Solo admin y administrativo deben acceder
   - Agregar: `const { hasAccess, loading } = useRequirePermission('/turnos')`

3. **`app/(dashboard)/reportes/page.tsx`**
   - Solo admin y administrativo deben acceder
   - Agregar: `const { hasAccess, loading } = useRequirePermission('/reportes')`

4. **`app/(dashboard)/dashboard/page.tsx`**
   - Todos excepto pantalla deben acceder
   - Agregar: `const { hasAccess, loading } = useRequirePermission('/dashboard')`

5. **`app/(dashboard)/agenda/page.tsx`**
   - Admin, administrativo y medico deben acceder
   - Agregar: `const { hasAccess, loading } = useRequirePermission('/agenda')`

#### PatrÃ³n de ImplementaciÃ³n

Para cada pÃ¡gina, seguir este patrÃ³n:

```typescript
// 1. Import
import { useRequirePermission } from '@/hooks/use-permissions'

// 2. En el componente (primera lÃ­nea)
export default function MiPagina() {
  const { hasAccess, loading: permissionLoading } = useRequirePermission('/mi-ruta')

  // 3. Antes del loading existente, agregar verificaciÃ³n
  if (permissionLoading) {
    return <LoadingSpinner />
  }

  if (!hasAccess) {
    return null
  }

  // 4. Resto del cÃ³digo existente...
}
```

---

## ğŸ¤” Decisiones Pendientes

### Permisos de EnfermerÃ­a
**SituaciÃ³n actual**: EnfermerÃ­a solo puede ver el Dashboard

**Preguntas para decidir**:
1. Â¿EnfermerÃ­a deberÃ­a poder llamar pacientes en su servicio especÃ­fico?
2. Â¿EnfermerÃ­a deberÃ­a ver la cola de su servicio en `/turnos`?
3. Â¿EnfermerÃ­a deberÃ­a gestionar estados (presente/ausente)?

**Opciones**:

**OpciÃ³n A - Mantener mÃ­nimo** (actual)
```typescript
'/dashboard': ['admin', 'administrativo', 'medico', 'enfermeria']
```

**OpciÃ³n B - Permisos de servicio**
```typescript
'/dashboard': ['admin', 'administrativo', 'medico', 'enfermeria'],
'/turnos': ['admin', 'administrativo', 'enfermeria'], // â† Agregar
// + Filtrar en /turnos para que enfermerÃ­a solo vea su servicio
```

**OpciÃ³n C - Crear ruta especÃ­fica**
```typescript
'/servicios/enfermeria': ['enfermeria'], // Ruta especÃ­fica para enfermerÃ­a
```

### Filtrado por Servicio en Turnos
Si enfermerÃ­a accede a `/turnos`, necesitamos:
1. Detectar quÃ© servicio pertenece al usuario
2. Filtrar `daily_queue` por `service_id`
3. Mostrar solo pacientes de ese servicio

---

## ğŸ§ª Testing Requerido

### Pruebas de Filtrado por InstituciÃ³n
- [ ] Login como usuario de InstituciÃ³n A
- [ ] Verificar que solo se ven consultorios de InstituciÃ³n A
- [ ] Verificar que solo se ven servicios de InstituciÃ³n A
- [ ] Intentar crear consultorio â†’ debe asignarse a InstituciÃ³n A
- [ ] Cambiar a InstituciÃ³n B â†’ debe ver solo datos de B

### Pruebas de Permisos por Rol

**Como Admin**:
- [ ] Ver todas las opciones del menÃº (8 opciones)
- [ ] Acceder a todas las rutas sin redirecciÃ³n
- [ ] Crear/editar/eliminar en profesionales, servicios, consultorios
- [ ] Modificar configuraciÃ³n TTS

**Como Administrativo**:
- [ ] Ver solo: Dashboard, Turnos, Agenda, Reportes (4 opciones)
- [ ] Acceder a `/turnos` correctamente
- [ ] Acceder a `/reportes` correctamente
- [ ] Intentar acceder a `/configuracion` â†’ redirigir a dashboard
- [ ] Intentar acceder a `/profesionales` â†’ redirigir a dashboard

**Como MÃ©dico**:
- [ ] Ver solo: Dashboard, Agenda (2 opciones)
- [ ] Acceder a `/agenda` correctamente
- [ ] Intentar acceder a `/turnos` â†’ redirigir a dashboard
- [ ] Intentar acceder a `/configuracion` â†’ redirigir a dashboard

**Como EnfermerÃ­a**:
- [ ] Ver solo: Dashboard (1 opciÃ³n)
- [ ] Acceder a `/dashboard` correctamente
- [ ] Intentar acceder a cualquier otra ruta â†’ redirigir a dashboard
- [ ] Verificar warning en consola al intentar acceso no autorizado

**Como Pantalla**:
- [ ] No ver ninguna opciÃ³n del menÃº de dashboard
- [ ] Intentar acceder a `/dashboard` â†’ redirigir
- [ ] Puede acceder a `/pantalla/[slug]` correctamente

### Pruebas de Seguridad
- [ ] Intentar modificar localStorage con rol diferente
- [ ] Intentar acceder por URL directa a ruta prohibida
- [ ] Verificar que RLS de Supabase sigue funcionando
- [ ] Intentar crear recurso para otra instituciÃ³n (debe fallar)

---

## ğŸ“‚ Estructura de Archivos Modificados/Creados

```
turnero-zs/
â”œâ”€â”€ app/(dashboard)/
â”‚   â”œâ”€â”€ layout.tsx                    # âœï¸ MODIFICADO - Filtrado dinÃ¡mico de menÃº
â”‚   â”œâ”€â”€ configuracion/page.tsx        # âœï¸ MODIFICADO - Protegido con hook
â”‚   â”œâ”€â”€ consultorios/page.tsx         # âœï¸ MODIFICADO - Filtrado por instituciÃ³n
â”‚   â””â”€â”€ servicios/page.tsx            # âœ… YA CORRECTO - Filtrado por instituciÃ³n
â”‚
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ permissions.ts                # ğŸ†• NUEVO - Sistema central de permisos
â”‚
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ use-permissions.ts            # ğŸ†• NUEVO - Hook de verificaciÃ³n
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ PERMISSIONS.md                # ğŸ†• NUEVO - DocumentaciÃ³n completa
    â””â”€â”€ SESSION_2025-01-13.md         # ğŸ†• NUEVO - Este documento
```

---

## ğŸš€ Plan para la PrÃ³xima SesiÃ³n

### Prioridad Alta
1. **Testing del sistema actual**
   - Probar filtrado por instituciÃ³n
   - Probar permisos con diferentes roles
   - Verificar redirecciones funcionan

2. **Decidir permisos de EnfermerÃ­a**
   - Â¿Necesitan acceso a `/turnos`?
   - Â¿Necesitan filtrado por servicio?

3. **Proteger pÃ¡ginas restantes**
   - Profesionales
   - Turnos
   - Reportes
   - Agenda
   - Dashboard

### Prioridad Media
4. **Implementar filtrado por servicio** (si se decide)
   - Agregar `service_id` al contexto del usuario
   - Filtrar `daily_queue` por servicio
   - Actualizar permisos de enfermerÃ­a

5. **Mejorar UX de permisos**
   - PÃ¡gina 403 personalizada en lugar de solo redirigir
   - Mensajes mÃ¡s claros cuando falta permiso

### Prioridad Baja
6. **AuditorÃ­a y logs**
   - Guardar intentos de acceso no autorizado en BD
   - Dashboard de auditorÃ­a para admin

---

## ğŸ’¡ Notas Importantes

### Principios de DiseÃ±o Aplicados
- **Defensa en profundidad**: MÃºltiples capas de seguridad
- **Privilegio mÃ­nimo**: Solo permisos necesarios por rol
- **Seguro por defecto**: Rutas no definidas = sin acceso
- **Fail-safe**: Si algo falla, denegar acceso

### Consideraciones de Performance
- `useRequirePermission` solo lee de localStorage (rÃ¡pido)
- Filtrado de menÃº se hace una vez en render
- No hay llamadas extra a Supabase por permisos

### Posibles Mejoras Futuras
- Almacenar permisos en BD (mÃ¡s flexible)
- Permisos granulares (no solo rutas, sino acciones)
- Cache de permisos en Redis
- Websockets para actualizaciÃ³n en tiempo real de permisos

---

## ğŸ“ Comandos Git Pendientes

**No se realizÃ³ commit en esta sesiÃ³n**. Los cambios estÃ¡n listos pero sin commitear.

Cuando estÃ©s listo para commitear:

```bash
git add .
git commit -m "feat: implementar RBAC y filtrado por instituciÃ³n

- Agregar filtrado por institution_id en consultorios
- Implementar sistema de permisos basado en roles (RBAC)
- Crear hook useRequirePermission para proteger rutas
- Filtrar menÃº dinÃ¡micamente segÃºn rol de usuario
- Proteger pÃ¡gina de configuraciÃ³n (solo admin)
- Documentar matriz de permisos en PERMISSIONS.md

BREAKING CHANGE: Usuarios no-admin ya no pueden acceder a pÃ¡ginas administrativas"
git push
```

---

## ğŸ¯ Estado Final de la SesiÃ³n

### Lo que funciona ahora:
âœ… Filtrado por instituciÃ³n en consultorios y servicios
âœ… Sistema RBAC implementado y documentado
âœ… MenÃº dinÃ¡mico segÃºn rol del usuario
âœ… ProtecciÃ³n de ruta de configuraciÃ³n
âœ… Redirecciones automÃ¡ticas si no hay permiso

### Lo que falta:
â³ Proteger las demÃ¡s pÃ¡ginas sensibles
â³ Testing completo del sistema
â³ Decidir permisos finales de enfermerÃ­a
â³ Commit de los cambios

### PrÃ³ximo paso inmediato:
1. Testing de filtrado por instituciÃ³n
2. Testing de permisos por rol
3. DecisiÃ³n sobre permisos de enfermerÃ­a
4. Proteger pÃ¡ginas restantes

---

**Fecha**: 13 de Enero 2025
**DuraciÃ³n**: ~2 horas
**Estado**: ImplementaciÃ³n completa, pendiente testing y extensiÃ³n a otras pÃ¡ginas
